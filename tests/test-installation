#!/bin/bash

# ===============================
# 🧪 TEST INSTALLATION V4
# ===============================

echo "🧪 Tests de validation des dotfiles V4..."

tests_passed=0
tests_total=0

# Test 1: Configuration shell
((tests_total++))
if [[ -f "$HOME/.zshrc" ]]; then
    echo "  ✅ Configuration shell trouvée"
    ((tests_passed++))
else
    echo "  ❌ Configuration shell manquante"
fi

# Test 2: Chargement ZSH
((tests_total++))
if zsh -c "source ~/.zshrc && echo 'test'" >/dev/null 2>&1; then
    echo "  ✅ Configuration ZSH se charge correctement"
    ((tests_passed++))
else
    echo "  ❌ Erreur de chargement ZSH"
fi

# Test 3: Fonctions disponibles
((tests_total++))
if zsh -c "source ~/.zshrc && type jp" >/dev/null 2>&1; then
    echo "  ✅ Fonctions personnalisées chargées"
    ((tests_passed++))
else
    echo "  ❌ Fonctions personnalisées manquantes"
fi

# Test 4: Outils essentiels
((tests_total++))
essential_tools=("git" "zsh" "tmux" "nvim")
tools_found=0

for tool in "${essential_tools[@]}"; do
    if command -v "$tool" >/dev/null 2>&1; then
        ((tools_found++))
    fi
done

if [[ $tools_found -eq ${#essential_tools[@]} ]]; then
    echo "  ✅ Tous les outils essentiels sont installés"
    ((tests_passed++))
else
    echo "  ❌ Outils manquants: $((${#essential_tools[@]} - tools_found))"
fi

# Test 5: Liens symboliques
((tests_total++))
symlinks=(".zshrc" ".tmux.conf" ".gitconfig")
links_found=0

for link in "${symlinks[@]}"; do
    if [[ -L "$HOME/$link" ]]; then
        ((links_found++))
    fi
done

if [[ $links_found -eq ${#symlinks[@]} ]]; then
    echo "  ✅ Tous les liens symboliques sont créés"
    ((tests_passed++))
else
    echo "  ❌ Liens symboliques manquants: $((${#symlinks[@]} - links_found))"
fi

echo
echo "📊 Résultats: $tests_passed/$tests_total tests passés"

if [[ $tests_passed -eq $tests_total ]]; then
    echo "🎉 Installation validée avec succès!"
    exit 0
else
    echo "⚠️ Installation partielle - quelques éléments manquent"
    exit 1
fi
