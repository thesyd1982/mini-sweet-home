#!/bin/bash

# ================================================
# üîß INSTALL PREREQUISITES - Essential Tools
# ================================================
# Installe curl, git, fzf et tmux si manquants

set -euo pipefail

readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly RED='\033[0;31m'
readonly RESET='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${RESET} $1"; }
log_success() { echo -e "${GREEN}[‚úì]${RESET} $1"; }
log_warning() { echo -e "${YELLOW}[‚ö†]${RESET} $1"; }
log_error() { echo -e "${RED}[‚úó]${RESET} $1"; }

command_exists() { command -v "$1" >/dev/null 2>&1; }

detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif command_exists apt; then
        echo "ubuntu"
    elif command_exists dnf; then
        echo "fedora"
    elif command_exists pacman; then
        echo "arch"
    elif command_exists yum; then
        echo "centos"
    else
        echo "unknown"
    fi
}

install_prerequisites() {
    local os=$(detect_os)
    local missing_tools=()
    
    echo "üîß Installation Prerequisites - Essential Tools"
    echo "==============================================="
    
    log_info "OS d√©tect√©: $os"
    
    # V√©rifier curl
    if command_exists curl; then
        log_success "curl d√©j√† install√©"
    else
        log_warning "curl manquant"
        missing_tools+=("curl")
    fi
    
    # V√©rifier git
    if command_exists git; then
        log_success "git d√©j√† install√©"
    else
        log_warning "git manquant"  
        missing_tools+=("git")
    fi
    
    # V√©rifier fzf
    if command_exists fzf; then
        log_success "fzf d√©j√† install√©"
    else
        log_warning "fzf manquant"
        missing_tools+=("fzf")
    fi
    
    # V√©rifier tmux
    if command_exists tmux; then
        log_success "tmux d√©j√† install√©"
    else
        log_warning "tmux manquant"
        missing_tools+=("tmux")
    fi
    
    if [[ ${#missing_tools[@]} -eq 0 ]]; then
        log_success "Tous les pr√©requis sont d√©j√† install√©s !"
        return 0
    fi
    
    log_info "Installation de : ${missing_tools[*]}"
    
    case "$os" in
        ubuntu|debian)
            log_info "Mise √† jour des paquets..."
            sudo apt update
            log_info "Installation des paquets..."
            sudo apt install -y "${missing_tools[@]}"
            ;;
        macos)
            if command_exists brew; then
                log_info "Installation via Homebrew..."
                brew install "${missing_tools[@]}"
            else
                log_error "Homebrew requis sur macOS"
                log_info "Installez Homebrew: /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
                return 1
            fi
            ;;
        fedora)
            log_info "Installation via DNF..."
            sudo dnf install -y "${missing_tools[@]}"
            ;;
        arch)
            log_info "Installation via Pacman..."
            sudo pacman -S --noconfirm "${missing_tools[@]}"
            ;;
        centos)
            log_info "Installation via YUM..."
            sudo yum install -y "${missing_tools[@]}"
            ;;
        *)
            log_error "OS non support√© pour installation automatique: $os"
            log_info "Installez manuellement:"
            for tool in "${missing_tools[@]}"; do
                echo "  - $tool"
            done
            return 1
            ;;
    esac
    
    # V√©rification post-installation
    echo
    log_info "V√©rification post-installation..."
    for tool in "${missing_tools[@]}"; do
        if command_exists "$tool"; then
            log_success "$tool install√© avec succ√®s"
        else
            log_error "√âchec installation de $tool"
            return 1
        fi
    done
    
    echo
    log_success "üéâ Tous les pr√©requis sont maintenant install√©s !"
    log_info "Vous pouvez maintenant installer Mini Sweet Home"
}

# Si ex√©cut√© directement
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    install_prerequisites "$@"
fi