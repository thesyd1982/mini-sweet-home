#!/bin/bash

# Script pour corriger MarkdownPreview dans WSL
# Usage: ./fix-markdown-preview

set -euo pipefail

echo "ðŸ”§ Correction de MarkdownPreview pour WSL..."

# VÃ©rifier si nous sommes dans WSL
if ! grep -qi microsoft /proc/version 2>/dev/null; then
    echo "âŒ Ce script est conÃ§u pour WSL uniquement"
    exit 1
fi

# Installer wslu si nÃ©cessaire (contient wslview)
if ! command -v wslview &> /dev/null; then
    echo "ðŸ“¦ Installation de wslu (contient wslview)..."
    
    # DÃ©tecter la distribution
    if command -v apt &> /dev/null; then
        # Ubuntu/Debian
        sudo apt update
        sudo apt install -y wslu
    elif command -v yum &> /dev/null; then
        # RHEL/CentOS
        sudo yum install -y wslu
    elif command -v pacman &> /dev/null; then
        # Arch
        sudo pacman -S wslu
    else
        echo "âŒ Distribution non supportÃ©e pour l'installation automatique de wslu"
        echo "ðŸ’¡ Installez manuellement wslu pour votre distribution"
        exit 1
    fi
else
    echo "âœ… wslview est dÃ©jÃ  installÃ©"
fi

# VÃ©rifier que wslview fonctionne
if wslview --help &> /dev/null; then
    echo "âœ… wslview fonctionne correctement"
else
    echo "âŒ wslview ne fonctionne pas correctement"
    exit 1
fi

# CrÃ©er une configuration optimisÃ©e pour WSL
echo "ðŸ“ CrÃ©ation de la configuration optimisÃ©e..."

# Backup de la configuration actuelle
CONFIG_FILE="$HOME/mini-sweet-home/configs/nvim/lua/plugins/markdown.lua"
if [[ -f "$CONFIG_FILE" ]]; then
    cp "$CONFIG_FILE" "$CONFIG_FILE.backup.$(date +%Y%m%d_%H%M%S)"
    echo "âœ… Backup crÃ©Ã©: $CONFIG_FILE.backup.*"
fi

# Ã‰crire la configuration optimisÃ©e
cat > "$CONFIG_FILE" << 'EOF'
return {
	"iamcco/markdown-preview.nvim",
	build = "cd app && npm install",
	cmd = { "MarkdownPreview", "MarkdownPreviewStop", "MarkdownPreviewToggle" },
	ft = { "markdown" },
	config = function()
		-- Configuration optimisÃ©e pour WSL
		vim.g.mkdp_auto_start = 0
		vim.g.mkdp_auto_close = 1
		
		-- Utilise wslview pour ouvrir dans le navigateur Windows
		vim.g.mkdp_browser = 'wslview'
		
		-- Configuration rÃ©seau
		vim.g.mkdp_open_to_the_world = 1
		vim.g.mkdp_open_ip = '127.0.0.1'
		vim.g.mkdp_port = '8080'
		vim.g.mkdp_echo_preview_url = 1
		
		-- Options de prÃ©visualisation
		vim.g.mkdp_preview_options = {
			mkit = {},
			katex = {},
			uml = {},
			maid = {},
			disable_sync_scroll = 0,
			sync_scroll_type = 'middle',
			hide_yaml_meta = 1,
			content_editable = false,
			disable_filename = 0
		}
		
		-- Theme CSS personnalisÃ© (optionnel)
		vim.g.mkdp_markdown_css = ''
		vim.g.mkdp_highlight_css = ''
		
		-- Page template personnalisÃ©e (optionnel)
		vim.g.mkdp_page_title = 'ã€Œ${name}ã€'
	end,
}
EOF

echo "âœ… Configuration mise Ã  jour avec wslview"

# Instructions pour l'utilisateur
echo ""
echo "ðŸŽ‰ Configuration terminÃ©e !"
echo ""
echo "ðŸ“ Instructions d'utilisation :"
echo "   1. RedÃ©marrez Neovim"
echo "   2. Ouvrez un fichier .md"
echo "   3. Utilisez :MarkdownPreview pour dÃ©marrer"
echo "   4. Utilisez :MarkdownPreviewStop pour arrÃªter"
echo "   5. Utilisez :MarkdownPreviewToggle pour basculer"
echo ""
echo "ðŸ”— L'URL sera affichÃ©e dans Neovim et le navigateur s'ouvrira automatiquement"
echo ""
echo "ðŸ’¡ Si vous prÃ©fÃ©rez un navigateur spÃ©cifique, modifiez mkdp_browser dans :"
echo "   $CONFIG_FILE"
echo ""
echo "   Exemples :"
echo "   - Chrome: vim.g.mkdp_browser = '/mnt/c/Program Files/Google/Chrome/Application/chrome.exe'"
echo "   - Edge: vim.g.mkdp_browser = '/mnt/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe'"
echo "   - Firefox: vim.g.mkdp_browser = '/mnt/c/Program Files/Mozilla Firefox/firefox.exe'"

exit 0
