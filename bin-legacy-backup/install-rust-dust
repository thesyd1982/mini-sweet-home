#!/bin/bash

# ==========================================
# ü¶Ä INSTALLER RUST, CARGO ET DUST
# ==========================================
# Usage: ./install-rust-dust
# Description: Installation compl√®te de Rust, Cargo et dust avec optimisations

set -euo pipefail

# Couleurs pour les logs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fonctions de logging
log() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[‚úì]${NC} $1"; }
warning() { echo -e "${YELLOW}[‚ö†]${NC} $1"; }
error() { echo -e "${RED}[‚úó]${NC} $1"; exit 1; }

# D√©tection de l'OS
detect_os() {
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if command -v apt >/dev/null 2>&1; then
            echo "ubuntu"
        elif command -v dnf >/dev/null 2>&1; then
            echo "fedora"
        elif command -v pacman >/dev/null 2>&1; then
            echo "arch"
        else
            echo "linux"
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
        echo "windows"
    else
        echo "unknown"
    fi
}

# V√©rifier si nous sommes dans WSL
is_wsl() {
    grep -qi microsoft /proc/version 2>/dev/null || false
}

# Installation des d√©pendances syst√®me
install_system_deps() {
    local os=$(detect_os)
    
    log "Installation des d√©pendances syst√®me pour $os..."
    
    case "$os" in
        ubuntu)
            sudo apt update
            sudo apt install -y curl build-essential gcc pkg-config libssl-dev
            ;;
        fedora)
            sudo dnf groupinstall -y "Development Tools"
            sudo dnf install -y curl gcc openssl-devel pkg-config
            ;;
        arch)
            sudo pacman -S --needed --noconfirm base-devel curl openssl pkg-config
            ;;
        macos)
            if ! command -v brew >/dev/null 2>&1; then
                log "Installation de Homebrew..."
                /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            fi
            brew install curl openssl pkg-config
            ;;
        *)
            warning "OS non reconnu, continuons avec l'installation de Rust..."
            ;;
    esac
    
    success "D√©pendances syst√®me install√©es"
}

# Installation de Rust via rustup
install_rust() {
    if command -v rustc >/dev/null 2>&1; then
        local rust_version=$(rustc --version | cut -d' ' -f2)
        log "Rust $rust_version est d√©j√† install√©"
        
        # Mettre √† jour Rust
        log "Mise √† jour de Rust..."
        rustup update
        success "Rust mis √† jour"
    else
        log "Installation de Rust via rustup..."
        
        # T√©l√©charger et installer rustup
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
        
        # Sourcer l'environnement Rust
        source "$HOME/.cargo/env"
        
        success "Rust install√© avec succ√®s"
    fi
    
    # V√©rifier l'installation
    if command -v rustc >/dev/null 2>&1 && command -v cargo >/dev/null 2>&1; then
        local rust_version=$(rustc --version)
        local cargo_version=$(cargo --version)
        success "‚úì $rust_version"
        success "‚úì $cargo_version"
    else
        error "√âchec de l'installation de Rust"
    fi
}

# Configuration optimis√©e de Cargo
configure_cargo() {
    log "Configuration de Cargo..."
    
    # Cr√©er le dossier de config s'il n'existe pas
    mkdir -p "$HOME/.cargo"
    
    # Configuration Cargo optimis√©e
    cat > "$HOME/.cargo/config.toml" << 'EOF'
[build]
# Utiliser tous les c≈ìurs disponibles pour la compilation
jobs = 0

# Optimisations pour les builds
[profile.release]
# Optimisation maximale
opt-level = 3
# Link-time optimization
lto = true
# R√©duction de la taille des binaires
codegen-units = 1
# Optimisations sp√©cifiques √† l'architecture
target-cpu = "native"

[profile.dev]
# Compilation plus rapide en dev
opt-level = 0
debug = true

# Registres alternatifs pour plus de rapidit√©
[registries]
crates-io = { index = "https://index.crates.io/" }

# Configuration des sources
[source.crates-io]
replace-with = "vendored-sources"

[source.vendored-sources]
directory = "vendor"

# R√©pertoire de cache optimis√©
[cargo-new]
name = "Your Name"
email = "your.email@example.com"

# Configuration r√©seau
[http]
check-revoke = false
timeout = 30

[net]
retry = 3
EOF
    
    # Si nous sommes dans WSL, ajouter des optimisations sp√©cifiques
    if is_wsl; then
        cat >> "$HOME/.cargo/config.toml" << 'EOF'

# Optimisations sp√©cifiques √† WSL
[build]
target-dir = "/tmp/cargo-target"
EOF
        success "Configuration WSL appliqu√©e"
    fi
    
    success "Configuration Cargo optimis√©e"
}

# Installation de dust et autres outils Rust utiles
install_rust_tools() {
    log "Installation de dust et autres outils Rust..."
    
    # S'assurer que cargo est dans le PATH
    source "$HOME/.cargo/env" 2>/dev/null || true
    
    if ! command -v cargo >/dev/null 2>&1; then
        error "Cargo n'est pas trouv√© dans le PATH"
    fi
    
    # Liste des outils √† installer
    local tools=(
        "du-dust"              # dust - analyseur d'espace disque
        "ripgrep"              # rg - recherche rapide
        "fd-find"              # fd - alternative √† find
        "bat"                  # cat avec coloration syntaxique
        "exa"                  # ls moderne
        "zoxide"               # cd intelligent
        "starship"             # prompt shell moderne
        "cargo-watch"          # surveillance des fichiers
        "cargo-edit"           # √©dition de Cargo.toml
        "cargo-update"         # mise √† jour des outils cargo
    )
    
    log "Installation de ${#tools[@]} outils Rust..."
    
    for tool in "${tools[@]}"; do
        if ! cargo install --list | grep -q "^$tool "; then
            log "Installation de $tool..."
            if cargo install "$tool"; then
                success "‚úì $tool install√©"
            else
                warning "‚ö† √âchec de l'installation de $tool"
            fi
        else
            success "‚úì $tool d√©j√† install√©"
        fi
    done
    
    # V√©rification sp√©cifique pour dust
    if command -v dust >/dev/null 2>&1; then
        local dust_version=$(dust --version | head -1)
        success "‚úì $dust_version install√© et fonctionnel"
        
        # Test rapide de dust
        log "Test de dust..."
        dust --version >/dev/null && success "‚úì dust fonctionne correctement"
    else
        error "dust n'est pas accessible dans le PATH"
    fi
}

# Configuration des aliases et PATH
setup_shell_integration() {
    log "Configuration de l'int√©gration shell..."
    
    # D√©terminer le shell par d√©faut
    local shell_config=""
    if [[ "$SHELL" == *"zsh"* ]]; then
        shell_config="$HOME/.zshrc"
    elif [[ "$SHELL" == *"bash"* ]]; then
        shell_config="$HOME/.bashrc"
    else
        shell_config="$HOME/.profile"
    fi
    
    # Ajouter Cargo au PATH si n√©cessaire
    if ! grep -q 'source "$HOME/.cargo/env"' "$shell_config" 2>/dev/null; then
        echo '' >> "$shell_config"
        echo '# Rust/Cargo environment' >> "$shell_config"
        echo 'source "$HOME/.cargo/env"' >> "$shell_config"
    fi
    
    # Ajouter des aliases utiles
    local aliases_block='
# Aliases Rust tools
alias ls="exa --icons --group-directories-first"
alias ll="exa -la --icons --group-directories-first"
alias tree="exa --tree --icons"
alias cat="bat --paging=never"
alias find="fd"
alias grep="rg"
alias du="dust"
alias cd="z"  # si zoxide est configur√©
'
    
    if ! grep -q "# Aliases Rust tools" "$shell_config" 2>/dev/null; then
        echo "$aliases_block" >> "$shell_config"
        success "Aliases ajout√©s √† $shell_config"
    fi
    
    # Configuration de zoxide si install√©
    if command -v zoxide >/dev/null 2>&1; then
        if ! grep -q 'eval "$(zoxide init' "$shell_config" 2>/dev/null; then
            echo 'eval "$(zoxide init bash)"' >> "$shell_config"  # ou zsh selon le shell
            success "Zoxide configur√©"
        fi
    fi
    
    # Configuration de starship si install√©
    if command -v starship >/dev/null 2>&1; then
        if ! grep -q 'eval "$(starship init' "$shell_config" 2>/dev/null; then
            echo 'eval "$(starship init bash)"' >> "$shell_config"  # ou zsh selon le shell
            success "Starship configur√©"
        fi
    fi
    
    success "Int√©gration shell configur√©e"
}

# Affichage des informations finales
show_completion_info() {
    echo ""
    success "üéâ Installation termin√©e avec succ√®s !"
    echo ""
    echo "üìù R√©sum√© de l'installation :"
    
    if command -v rustc >/dev/null 2>&1; then
        echo "   ‚úì $(rustc --version)"
    fi
    
    if command -v cargo >/dev/null 2>&1; then
        echo "   ‚úì $(cargo --version)"
    fi
    
    if command -v dust >/dev/null 2>&1; then
        echo "   ‚úì $(dust --version | head -1)"
    fi
    
    echo ""
    echo "üîß Outils install√©s :"
    local tools=("dust" "rg" "fd" "bat" "exa" "zoxide" "starship")
    for tool in "${tools[@]}"; do
        if command -v "$tool" >/dev/null 2>&1; then
            echo "   ‚úì $tool"
        fi
    done
    
    echo ""
    echo "üöÄ Pour utiliser les nouveaux outils :"
    echo "   1. Red√©marrez votre terminal ou ex√©cutez :"
    echo "      source ~/.bashrc  # ou ~/.zshrc"
    echo ""
    echo "   2. Testez dust :"
    echo "      dust"
    echo "      dust -d 2 /home"
    echo ""
    echo "   3. Autres commandes utiles :"
    echo "      rg 'pattern'     # recherche rapide"
    echo "      fd filename      # trouver des fichiers"
    echo "      bat file.txt     # afficher avec coloration"
    echo "      exa -la          # listing am√©lior√©"
    echo ""
    echo "üìö Documentation :"
    echo "   - Rust: https://doc.rust-lang.org/"
    echo "   - Dust: https://github.com/bootandy/dust"
    echo "   - Cargo: https://doc.rust-lang.org/cargo/"
}

# Fonction principale
main() {
    log "ü¶Ä D√©but de l'installation Rust, Cargo et dust"
    
    if is_wsl; then
        log "Environnement WSL d√©tect√©"
    fi
    
    install_system_deps
    install_rust
    configure_cargo
    install_rust_tools
    setup_shell_integration
    show_completion_info
    
    success "Installation compl√®te termin√©e !"
}

# Ex√©cution du script
main "$@"
