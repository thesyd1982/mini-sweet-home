#!/bin/bash
# MSH Secrets Management Tool
# Secure management of environment variables and API keys

set -euo pipefail

# Colors
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly RED='\033[0;31m'
readonly NC='\033[0m'

# Paths
readonly MSH_DIR="$HOME/mini-sweet-home"
readonly ENV_FILE="$MSH_DIR/.env"
readonly TEMPLATE_FILE="$MSH_DIR/.env.template"

show_help() {
    echo -e "${CYAN}ðŸ” MSH Secrets Management Tool${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo
    echo -e "${GREEN}Commands:${NC}"
    echo "  init              - Initialize .env from template"
    echo "  edit              - Edit .env file securely"
    echo "  show              - Show current environment variables (masked)"
    echo "  validate          - Validate .env file format"
    echo "  backup            - Create encrypted backup of .env"
    echo "  restore           - Restore .env from backup"
    echo "  clean             - Remove all secret files (with confirmation)"
    echo
    echo -e "${GREEN}Examples:${NC}"
    echo "  msh-secrets init          - Set up your secrets"
    echo "  msh-secrets edit          - Edit your API keys"
    echo "  msh-secrets show          - Check what's configured"
    echo "  msh-secrets validate      - Check for syntax errors"
}

log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

init_env() {
    if [[ -f "$ENV_FILE" ]]; then
        log_warning ".env file already exists"
        read -p "Overwrite existing .env? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "Cancelled"
            return 0
        fi
    fi
    
    if [[ ! -f "$TEMPLATE_FILE" ]]; then
        log_error "Template file not found: $TEMPLATE_FILE"
        return 1
    fi
    
    cp "$TEMPLATE_FILE" "$ENV_FILE"
    log_success ".env file created from template"
    log_info "Edit $ENV_FILE to add your actual API keys"
    
    # Set secure permissions
    chmod 600 "$ENV_FILE"
    log_success "Secure permissions set (600)"
}

edit_env() {
    if [[ ! -f "$ENV_FILE" ]]; then
        log_warning ".env file doesn't exist"
        read -p "Create from template? (Y/n): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            init_env
        else
            return 1
        fi
    fi
    
    # Use preferred editor
    local editor="${EDITOR:-nvim}"
    if ! command -v "$editor" >/dev/null 2>&1; then
        editor="nano"
    fi
    
    log_info "Opening .env with $editor"
    "$editor" "$ENV_FILE"
    
    # Validate after editing
    validate_env
}

show_env() {
    if [[ ! -f "$ENV_FILE" ]]; then
        log_error ".env file not found. Run 'msh-secrets init' first."
        return 1
    fi
    
    log_info "Current environment variables (values masked for security):"
    echo
    
    while IFS= read -r line || [[ -n "$line" ]]; do
        # Skip comments and empty lines
        [[ "$line" =~ ^[[:space:]]*# ]] && continue
        [[ -z "${line// }" ]] && continue
        
        if [[ "$line" =~ ^[[:space:]]*([A-Za-z_][A-Za-z0-9_]*)=(.*)$ ]]; then
            local var_name="${BASH_REMATCH[1]}"
            local var_value="${BASH_REMATCH[2]}"
            
            # Mask the value
            if [[ -n "$var_value" && "$var_value" != "your_"*"_here" ]]; then
                local masked_value="${var_value:0:4}****${var_value: -4}"
                echo -e "  ${GREEN}$var_name${NC}=${masked_value}"
            else
                echo -e "  ${YELLOW}$var_name${NC}=${RED}(not configured)${NC}"
            fi
        fi
    done < "$ENV_FILE"
}

validate_env() {
    if [[ ! -f "$ENV_FILE" ]]; then
        log_error ".env file not found"
        return 1
    fi
    
    local errors=0
    local line_num=0
    
    while IFS= read -r line || [[ -n "$line" ]]; do
        ((line_num++))
        
        # Skip comments and empty lines
        [[ "$line" =~ ^[[:space:]]*# ]] && continue
        [[ -z "${line// }" ]] && continue
        
        # Check format
        if [[ ! "$line" =~ ^[[:space:]]*[A-Za-z_][A-Za-z0-9_]*=.*$ ]]; then
            log_error "Line $line_num: Invalid format: $line"
            ((errors++))
        fi
        
        # Check for placeholder values
        if [[ "$line" =~ your_.*_here ]]; then
            log_warning "Line $line_num: Placeholder value detected: ${line%%=*}"
        fi
    done < "$ENV_FILE"
    
    if [[ $errors -eq 0 ]]; then
        log_success ".env file is valid"
        return 0
    else
        log_error "Found $errors error(s) in .env file"
        return 1
    fi
}

backup_env() {
    if [[ ! -f "$ENV_FILE" ]]; then
        log_error ".env file not found"
        return 1
    fi
    
    local backup_file="$MSH_DIR/.env.backup.$(date +%Y%m%d_%H%M%S)"
    
    # Create encrypted backup if gpg is available
    if command -v gpg >/dev/null 2>&1; then
        log_info "Creating encrypted backup..."
        gpg --symmetric --cipher-algo AES256 --output "$backup_file.gpg" "$ENV_FILE"
        log_success "Encrypted backup created: $backup_file.gpg"
    else
        # Simple copy with warning
        cp "$ENV_FILE" "$backup_file"
        chmod 600 "$backup_file"
        log_warning "GPG not available - created unencrypted backup: $backup_file"
        log_warning "Consider installing GPG for encrypted backups"
    fi
}

clean_secrets() {
    log_warning "This will remove all secret files (.env, backups, etc.)"
    read -p "Are you sure? Type 'yes' to confirm: " -r
    
    if [[ "$REPLY" == "yes" ]]; then
        rm -f "$ENV_FILE"
        rm -f "$MSH_DIR"/.env.backup.*
        rm -f "$MSH_DIR"/.env.backup.*.gpg
        log_success "All secret files removed"
    else
        log_info "Cancelled"
    fi
}

main() {
    local command="${1:-help}"
    
    case "$command" in
        init)
            init_env
            ;;
        edit)
            edit_env
            ;;
        show)
            show_env
            ;;
        validate)
            validate_env
            ;;
        backup)
            backup_env
            ;;
        clean)
            clean_secrets
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Unknown command: $command"
            echo "Run 'msh-secrets help' for usage information"
            return 1
            ;;
    esac
}

main "$@"